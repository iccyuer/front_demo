<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/user.css">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <!-- <script src="./js/bootstrap-paginator.min.js"></script> -->
</head>

<body>
    <div class="head">
        <img src="./images/review.png" alt="">
    </div>
    <div class="form inset-border flex">
        <div class="arrow arrow-1"></div>
        <div class="arrow arrow-2"></div>
        <div class="arrow arrow-3"></div>
        <div class="arrow arrow-4"></div>
        <div class="form-item">
            <div class="label"></div>
            <div class=""></div>
        </div>
        <form class="row gx-3 gy-2 align-items-center">
            <div class="col-auto flex">
                <label class="" for="specificSizeInputName">姓名</label>
                <input type="text" class="form-control inset-border form-user-name" id="specificSizeInputName" placeholder="请输入姓名"
                    autocomplete="off">
            </div>
            <div class="col-auto flex">
                <label class="" for="specificSizeSelect">部门</label>
                <select class="form-select form-select-department" id="specificSizeSelect">
                    <option selected>请选择部门</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary form-search-btn">查询</button>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary form-add-btn" data-bs-toggle="modal"
                    data-bs-target="#exampleModal">新增</button>
            </div>
        </form>
    </div>
    <div class="table- inset-border">
        <div class="border- border-1-"></div>
        <div class="border- border-2-"></div>
        <div class="border- border-3-"></div>
        <div class="border- border-4-"></div>
        <table class="table table-bordered align-middle table-body">
            <thead class="align-middle">
                <tr>
                    <th scope="col">姓名</th>
                    <th scope="col">部门</th>
                    <th scope="col">训练次数</th>
                    <th scope="col">最后训练时间</th>
                    <th scope="col">备注</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="tablecontent"></div>
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- modal input -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content inset-border">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">添加新人员</h5>
                    <img src="./images/close.png" alt="" class="btn-close-" data-bs-dismiss="modal">
                </div>
                <div class="modal-body">
                    <form class="form-input">
                        <input type="text" class="form-control inset-border form-user-name-modal" placeholder="请输入姓名"
                            autocomplete="off">
                        <input type="text" class="form-control inset-border form-user-no-modal" placeholder="请输入编号"
                            autocomplete="off">
                        <div class="col-auto flex">
                            <select class="form-select form-select-department-modal">
                                <option selected>请选择部门</option>
                            </select>
                        </div>
                        <div class="flex department-add flex-justify-content-space-around">
                            <img src="./images/add.png" alt="">
                            <div>新添部门</div>
                        </div>
                        <div class="flex file-box">
                            <img src="" alt="" class="file-img" style="display: none;">
                            <input type="file" class="form-control form-file" aria-label="file example" style="height: 38px;" accept="image/*">
                        </div>
                        <input type="text" class="form-control inset-border form-remark-modal" placeholder="备注"
                            autocomplete="off">
                    </form>
                </div>
                <div class="flex flex-justify-content-space-around confirm-btns">
                    <button type="button" class="btn btn-secondary modal-user-confirm">确定</button>
                    <button type="button" class="btn btn-secondary modal-cancel" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- modal input2 -->
    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content inset-border">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">添加部门</h5>
                    <img src="./images/close.png" alt="" class="btn-close-" data-bs-dismiss="modal">
                </div>
                <div class="modal-body">
                    <form class="form-input2">
                        <input type="text" class="form-control inset-border form-department_name-modal" placeholder="请输入部门"
                            autocomplete="off" required>
                        <input type="text" class="form-control inset-border form-department_remark-modal" placeholder="备注"
                            autocomplete="off">
                    </form>
                </div>
                <div class="flex flex-justify-content-space-around confirm-btns">
                    <button type="button" class="btn btn-secondary modal-department-confirm">确定</button>
                    <button type="button" class="btn btn-secondary modal-cancel" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>


    <!-- modal-table -->
    <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-table">
            <div class="modal-content inset-border">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">张三的训练记录</h5>
                    <img src="./images/close.png" alt="" class="btn-close-" data-bs-dismiss="modal">
                </div>
                <div class="modal-body">
                    <table class="table table-bordered align-middle">
                        <thead class="align-middle">
                            <tr>
                                <th scope="col">训练编号</th>
                                <th scope="col">地图名称</th>
                                <th scope="col">训练时间</th>
                                <th scope="col">综合得分</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>123213</td>
                                <td>居民楼搜索射击</td>
                                <td>2021-04-22 12:00:00</td>
                                <td>232321</td>
                                <td class="flex flex-justify-content-space-around">
                                    <button class="info-btn">查看详细数据</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
    <script>
        $(function() {
            let modalel = document.getElementById('exampleModal');
            let modal = new bootstrap.Modal(modalel, { keyboard: false })
            let modalel2 = document.getElementById('exampleModal2');
            let modal2 = new bootstrap.Modal(modalel2, { keyboard: false })
            let modalel3 = document.getElementById('exampleModal3');
            let modal3 = new bootstrap.Modal(modalel3, { keyboard: false })

            $('.modal-body').on('click', '.department-add', function(){
                modal2.show();
            })


            $('body').on('hidden.bs.modal', '#exampleModal', function () {
                $('.form-user-name-modal').val('');
                $('.form-user-no-modal').val('');
                $('.form-select-department-modal').val('');
                $('.file-img').attr('src','').hide();
                $('.form-file').val('');
                $('.form-remark-modal').val('');
            });


            // 部门
            function getDepartment() {
                $.get('/user/getDepartment', function(res) {
                    if (res.code == 0) {
                        console.log(res.result)
                        if (Array.isArray(res.result)) {
                            var tpl = res.result.map(department => {
                                return `<option value="${department.department_name}">${department.department_name}</option>`
                            }).join('')
                            tpl='<option selected>请选择部门</option>'+tpl;
                            $('.form-select-department').html(tpl);

                            var tpl2 = res.result.map(department => {
                                return `<option value="${department.id}">${department.department_name}</option>`
                            }).join('')
                            tpl2='<option selected>请选择部门</option>'+tpl2;
                            $('.form-select-department-modal').html(tpl2);
                        }
                    } else {
                        // console.error(res.msg)
                        $('.toast-body').html('res.msg');
                        toast.show()
                    }
                },'json')
            }
            getDepartment()


            let page = 1;
            let size = 10;
            function getUserList() {
                let user_name = $('.form-user-name').val();
                console.log('user_name', user_name);
                let department_name = $('.form-select-department').val();
                console.log('department_name', department_name);
                var data = {
                    page: page,
                    size: size
                }
                if (!!user_name) data.user_name = user_name;
                if (!!department_name && department_name!='请选择部门') data.department_name = department_name;
                $.get('/user/searchUser', data, function(res) {
                    console.log('res', res)
                    if (res.code == 0) {
                        console.log(res.result)
                        let { count, list } = res.result;
                        if (count && Number.isInteger) {
                            renderPagination(page, Math.ceil(count/size))
                        }
                        if (list && Array.isArray(list)) {
                            var tpl = list.map(item => {
                                return `<tr>
                                    <td>${item.user_name}</td>
                                    <td>${item.department_name}</td>
                                    <td>${item.train_num}次</td>
                                    <td>${item.last_train_time}</td>
                                    <td style="min-width: 400px;">备注</td>
                                    <td class="flex flex-justify-content-space-around">
                                        <button class="history-btn" user-id="${item.id}">查看历史战绩</button>
                                        <button class="info-btn" user-id="${item.id}">修改个人信息</button>
                                    </td>
                                </tr>`
                            }).join('')
                            $('.table-body tbody').html(tpl)
                        }
                    } else {
                        console.error(res.msg)
                    }
                },'json')
            }
            getUserList()


            // 查询
            $('.form').on('click', '.form-search-btn', function() {
                getUserList()
            })
            // 新增
            // $('.form').on('click', '.form-add-btn', function() {
            //     getUserList()
            // })



            function renderPagination(currentPage, totalPage) {
                var tpl = ''
                for (let i = 0; i < totalPage; i++) {
                    tpl += `<li class="page-item ${currentPage == i + 1 ? 'active' : ''}"><a class="page-link" href="javascript:;" index=${i + 1} >${i + 1}</a></li>`
                }
                $('.pagination').html(tpl);
            }
            $('.pagination').on('click', '.page-link', function () {
                let clickpage = $(this);
                page = clickpage.attr('index');
                getUserList();
            })


            var toastLiveExample = document.getElementById('liveToast')
            var toast = new bootstrap.Toast(toastLiveExample)
            
            // 新增部门
            $('.modal-content').on('click', '.modal-department-confirm',function(){
                let department_name = $('.form-department_name-modal').val();
                let remark = $('.form-department_remark-modal').val();
                if (!department_name) {
                    $('.toast-body').html(`<div class="toast-body-warning">请填写部门</div>`);
                    toast.show()
                    return;
                }
                let formData = new FormData();
                formData.append('department_name',department_name);
                formData.append('remark',remark);
                $.ajax({
                    url: '/user/createDepartment',
                    data: formData,
                    type: "POST",
                    success: function(res){
                        if (res.code == 0) {
                            $('.toast-body').html(res.msg);
                            toast.show();
                            getDepartment();
                            modal2.hide();
                        } else {
                            $('.toast-body').html(`<div class="toast-body-warning">${res.msg}</div>`);
                            toast.show()
                        }
                    },
                    dataType: 'json',
                    processData: false, // 不处理数据
                    contentType: false // 不设置内容类型
                })
            })


            let user_file = null;
            // form-file
            $('.modal-content').on('change', '.form-file', function(e){
                const files = e.target.files;
                let self = this;
                if (files[0] !== undefined) {
                    user_file = files[0];
                    const fr = new FileReader();
                    fr.readAsDataURL(user_file);
                    fr.addEventListener("load", (e) => {
                        $('.file-img').attr('src',e.target.result);
                        $('.file-img').show();
                    });
                }
            })

            // 新增用户
            $('.modal-content').on('click', '.modal-user-confirm',function(){
                let user_name = $('.form-user-name-modal').val();
                let user_no = $('.form-user-no-modal').val();
                let department_id = $('.form-select-department-modal').val();
                let remark = $('.form-remark-modal').val();
                let user_id = $('.modal-user-confirm').attr('user-id');

                if (!user_name) {
                    $('.toast-body').html(`<div class="toast-body-warning">请填写姓名</div>`);
                    toast.show()
                    return;
                }
                if (!user_no) {
                    $('.toast-body').html(`<div class="toast-body-warning">请填写编号</div>`);
                    toast.show()
                    return;
                }
                if (!department_id || department_id == '请选择部门') {
                    $('.toast-body').html(`<div class="toast-body-warning">请选择部门</div>`);
                    toast.show()
                    return;
                }

                if (user_id) {
                    formData = new FormData();
                    formData.append('user_id',user_id);
                    formData.append('user_name',user_name);
                    formData.append('user_no',user_no);
                    formData.append('department_id',department_id);
                    if(!!user_file) formData.append('pic',user_file);
                    if(!!remark) formData.append('remark',remark);
                    $.ajax({
                        url: '/user/modifyUser',
                        data: formData,
                        type: "POST",
                        success: function(res){
                            if (res.code == 0) {
                                $('.toast-body').html(res.msg);
                                toast.show();
                                modal.hide();
                            } else {
                                $('.toast-body').html(`<div class="toast-body-warning">${res.msg}</div>`);
                                toast.show()
                            }
                        },
                        dataType: 'json',
                        processData: false, // 不处理数据
                        contentType: false // 不设置内容类型
                    })
                } else {
                    let formData = new FormData();
                    formData.append('user_name',user_name);
                    formData.append('user_no',user_no);
                    formData.append('department_id',department_id);
                    if(!!user_file) formData.append('pic',user_file);
                    if(!!remark) formData.append('remark',remark);
                    $.ajax({
                        url: '/user/createUser',
                        data: formData,
                        type: "POST",
                        success: function(res){
                            if (res.code == 0) {
                                $('.toast-body').html(res.msg);
                                toast.show();
                                modal.hide();
                            } else {
                                $('.toast-body').html(`<div class="toast-body-warning">${res.msg}</div>`);
                                toast.show()
                            }
                        },
                        dataType: 'json',
                        processData: false, // 不处理数据
                        contentType: false // 不设置内容类型
                    })
                }
                getUserList();
            })

            // 查看历史战绩
            $('.table-body').on('click', '.history-btn', function(){
                let user_id = $(this).attr('user-id');
                console.log(user_id);
                $.get(`/record/historyRecord?user_id=${user_id}`, function(res) {
                    console.log('res', res)
                    if (res.code == 0) {
                        let { count,list } = res.result;
                        if (list && Array.isArray(list)) {
                            var tpl = list.map(item => {
                                return `<tr>
                                    <td>${item.train_no}</td>
                                    <td>${item.map_name}</td>
                                    <td>${item.start_time}</td>
                                    <td>${item.total_score}</td>
                                    <td class="flex flex-justify-content-space-around">
                                        <button class="review-btn" train_no=${item.train_no}>查看详细数据</button>
                                    </td>
                                </tr>`
                            }).join('')
                            $('.modal-body tbody').html(tpl)
                            modal3.show();
                        }
                    }
                },'json');
            });
            // 修改个人信息
            $('.table-body').on('click', '.info-btn', function(){
                let user_id = $(this).attr('user-id');
                console.log(user_id);
                $.get(`/user/getUserInfo?user_id=${user_id}`, function(res) {
                    console.log('res', res)
                    if (res.code == 0) {
                        let { result } = res;
                        $('.form-user-name-modal').val(result.user_name);
                        $('.form-user-no-modal').val(result.user_no);
                        $('.form-select-department-modal').val(result.department_id);
                        if (result.pic) {
                            $('.file-img').attr('src',`http://vr.dwtv.tv${result.pic}`).show();
                        }
                        $('.form-remark-modal').val(result.remark);
                        $('.modal-user-confirm').attr('user-id',user_id);
                        modal.show();
                    }
                },'json');
            });


            $('.modal-body').on('click', '.review-btn', function(){
                let train_no = $(this).attr('train_no');
                location.href = `./review.html?train_no=${train_no}`
            });
        })
    </script>
</body>




</html>